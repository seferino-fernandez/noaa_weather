name: Continuous Deployment - Build Binaries

permissions:
    # Required to write the binary artifacts to the GitHub release.
    contents: write

# This workflow is triggered after the `release` job in `release.yml`
# successfully publishes a GitHub Release.
on:
    release:
        types: [published]

env:
    # This must match the `[[bin]] name` in noaa_weather_cli/Cargo.toml.
    BINARY_NAME: "noaa-weather"
    # The repository owner, used to ensure this workflow only runs in the main repository.
    REPO_OWNER: "seferino-fernandez"

jobs:
    upload-assets:
        name: Build and Upload Assets for ${{ matrix.target }}
        # This job will only run if:
        # 1. The action is running in your original repository, not a fork.
        # 2. The release tag starts with `noaa_weather_cli-v`, which is the tag
        #    generated by release-plz for the CLI package, per our config.
        if: github.repository_owner == env.REPO_OWNER && startsWith(github.event.release.tag_name, 'noaa_weather_cli-v')
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    # Linux (amd64, arm64)
                    - target: x86_64-unknown-linux-gnu
                      os: ubuntu-latest
                    - target: aarch64-unknown-linux-gnu
                      os: ubuntu-latest
                    # macOS (Intel & Apple Silicon)
                    - target: x86_64-apple-darwin
                      os: macos-latest
                    - target: aarch64-apple-darwin
                      os: macos-latest
                    # Windows (amd64, arm64)
                    - target: x86_64-pc-windows-msvc
                      os: windows-latest
                    - target: aarch64-pc-windows-msvc
                      os: windows-latest

        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  # Checkout the specific git tag that triggered this release workflow
                  # to ensure we build the exact version of the code that was released.
                  ref: ${{ github.ref_name }}

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@nightly
              with:
                  targets: ${{ matrix.target }}

            - name: Install linker for Linux aarch64 cross-compilation
              if: runner.os == 'Linux' && matrix.target == 'aarch64-unknown-linux-gnu'
              run: |
                  sudo apt-get update
                  sudo apt-get install -y gcc-aarch64-linux-gnu

            - name: Build binary
              run: cargo build --release --locked --bin ${{ env.BINARY_NAME }} --target ${{ matrix.target }}

            - name: Upload binary to release
              uses: taiki-e/upload-rust-binary-action@v1
              with:
                  # The name of the binary to upload from the target/release directory.
                  bin: ${{ env.BINARY_NAME }}
                  # The Rust target triple for the built binary.
                  target: ${{ matrix.target }}
                  # The GitHub token for authentication.
                  token: ${{ secrets.GITHUB_TOKEN }}
                  # Create a .tar.gz archive for all non-windows targets.
                  tar: unix
                  # Create a .zip archive for all windows targets.
                  zip: windows
